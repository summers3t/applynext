import"../chunks/Bzak7iHL.js";import"../chunks/CYsr-paj.js";import{o as ie}from"../chunks/C96VhvSi.js";import{p as le,i as a,j as t,f as h,t as B,b as _,c as ne,m as b,s as n,d as i,r as o,e as ve,a as ce}from"../chunks/BAKKtip-.js";import{g as de,e as z,s as x,r as pe}from"../chunks/C9sUR3Xw.js";import{i as F}from"../chunks/B8FQCOyo.js";import{p as me,e as fe,i as ue}from"../chunks/BwJYG__W.js";import{r as O,b as E}from"../chunks/fZbFrnr1.js";import{i as _e}from"../chunks/VeT9vhzU.js";import{s as G}from"../chunks/Dew1yWqH.js";import{s as H}from"../chunks/DIGPD2v9.js";import{g as Q}from"../chunks/DXZnKqI-.js";var be=h('<div style="color:#c00;"> </div>'),je=h('<form class="create-form svelte-tr34vb"><div><label for="proj-name" class="svelte-tr34vb">Project Name</label> <input id="proj-name" type="text" required maxlength="80" class="svelte-tr34vb"/></div> <div><label for="proj-desc" class="svelte-tr34vb">Description (optional)</label> <textarea id="proj-desc" maxlength="200" rows="2" class="svelte-tr34vb"></textarea></div> <div><label for="proj-deadline" class="svelte-tr34vb">Deadline (optional)</label> <input id="proj-deadline" type="date" class="svelte-tr34vb"/></div> <div><button type="submit" class="create-btn svelte-tr34vb"> </button></div> <!></form>'),ge=h("<p>Loading projects…</p>"),xe=h("<p>You have no projects yet. Create one to get started!</p>"),he=h('<div class="project-row svelte-tr34vb"><span style="min-width:13em;"><b>Project:</b> </span> <span> </span> <span class="deadline svelte-tr34vb"> </span> <span class="role-badge svelte-tr34vb"> </span></div>'),ye=h("<div></div>"),Pe=h('<div class="project-list-container svelte-tr34vb"><div class="header-row svelte-tr34vb"><h1>ApplyNext Projects</h1> <button class="create-btn svelte-tr34vb"> </button></div> <!> <!></div>');function Le(S,T){le(T,!1);let P=b([]),A=b(!1),j=b(""),w=b(!1),y=b(""),N=b(""),$=b(null),C=b(!1),s=de(H);H.subscribe(e=>{var r;s=e,(r=s==null?void 0:s.user)!=null&&r.id&&q()});async function q(){if(!s){a(P,[]);return}a(A,!0),a(j,"");const{data:e,error:r}=await G.from("project_users").select("role, projects(id, name, description, deadline)").eq("user_id",s.user.id);if(r){a(j,r.message),a(A,!1);return}console.log("Project Users Result:",e),a(P,(e??[]).map(l=>{const d=Array.isArray(l.projects)?l.projects[0]:l.projects;return d&&{...d,role:l.role}}).filter(Boolean)),console.log("Projects found:",t(P)),a(A,!1)}async function W(){var f;if(!t(y).trim()||!((f=s==null?void 0:s.user)!=null&&f.id))return;a(C,!0),a(j,"");const{data:e,error:r}=await G.from("projects").insert([{name:t(y).trim(),description:t(N).trim()||null,created_by:s.user.id,deadline:t($)}]).select();if(r||!e||!e[0]){a(j,(r==null?void 0:r.message)??"Could not create project"),a(C,!1);return}const l=e[0],{error:d}=await G.from("project_users").insert([{project_id:l.id,user_id:s.user.id,role:"admin"}]);if(d){a(j,d.message),a(C,!1);return}else console.log("Inserted project_user:",{project_id:l.id,user_id:s.user.id,role:"admin"});a(w,!1),a(y,""),a(N,""),a($,null),await q(),Q(`/projects/${l.id}`)}function X(e){if(!e)return"";const r=e.split("-");return r.length!==3?e:`${r[2]}.${r[1]}.${r[0]}`}ie(()=>{var e;(e=s==null?void 0:s.user)!=null&&e.id&&q()}),H.subscribe(e=>{var r;s=e,(r=s==null?void 0:s.user)!=null&&r.id&&q()}),_e();var I=Pe(),L=i(I),M=n(i(L),2),Z=i(M,!0);o(M),o(L);var J=n(L,2);{var V=e=>{var r=je(),l=i(r),d=n(i(l),2);O(d),o(l);var f=n(l,2),p=n(i(f),2);pe(p),o(f);var m=n(f,2),U=n(i(m),2);O(U),o(m);var c=n(m,2),u=i(c),D=i(u,!0);o(u),o(c);var R=n(c,2);{var k=v=>{var g=be(),Y=i(g,!0);o(g),B(()=>x(Y,t(j))),_(v,g)};F(R,v=>{t(j)&&v(k)})}o(r),B(v=>{u.disabled=v,x(D,t(C)?"Creating…":"Create")},[()=>t(C)||!t(y).trim()]),E(d,()=>t(y),v=>a(y,v)),E(p,()=>t(N),v=>a(N,v)),E(U,()=>t($),v=>a($,v)),z("submit",r,me(W)),_(e,r)};F(J,e=>{t(w)&&e(V)})}var ee=n(J,2);{var re=e=>{var r=ge();_(e,r)},te=e=>{var r=ve(),l=ce(r);{var d=p=>{var m=xe();_(p,m)},f=p=>{var m=ye();fe(m,5,()=>t(P),ue,(U,c)=>{var u=he(),D=i(u),R=n(i(D));o(D);var k=n(D,2),v=i(k,!0);o(k);var g=n(k,2),Y=i(g,!0);o(g);var K=n(g,2),ae=i(K,!0);o(K),o(u),B((se,oe)=>{x(R,` ${t(c).name??""}`),x(v,t(c).description),x(Y,se),x(ae,oe)},[()=>t(c).deadline?X(t(c).deadline):"",()=>t(c).role[0].toUpperCase()+t(c).role.slice(1)]),z("click",u,()=>Q(`/projects/${t(c).id}`)),_(U,u)}),o(m),_(p,m)};F(l,p=>{t(P).length===0?p(d):p(f,!1)},!0)}_(e,r)};F(ee,e=>{t(A)?e(re):e(te,!1)})}o(I),B(()=>x(Z,t(w)?"Cancel":"Create Project")),z("click",M,()=>a(w,!t(w))),_(S,I),ne()}export{Le as component};
